<!DOCTYPE html>
<html>
  <head>
    <title>libvpx cli generator</title>
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        border: 0;
      }

      input {
        vertical-align:middle;
      }

      input[type='radio'] {
        cursor: pointer; 
      }

      label { 
        cursor: pointer; 
      }

      .section {
        margin-bottom: 5px;
        margin-left: 10px;
      }

      .section .title {
        font-weight: bold;
      }

      .section .body {
        margin-left: 5px;
      }

      .selected {
        padding-bottom: 1px;
        border-bottom: 1px dashed;
      }

      .indent {
        margin-left: 10px;
      }

      .value {
        font-size: 8pt;
      }

      #cmd {
        background-color:black;
        padding-top:10px;
        padding-bottom:10px;
        padding-left:5px;
        margin-bottom: 10px;
        height: 3em;
      }

      #cmd-copy {
        margin-right: 20px;
      }

      #cmd-line {
        font-size:12pt;
        font-family:monospace;
        color:white;
      }

      #panel p {
        display: inline;
      }

      [rv-on-click]:not([rv-on-click=""]) {
        cursor: pointer;
      }

    </style>
  </head>
  <body>
    <div id="panel">
      <div id="cmd" style="visibility:hidden">
        <button style="float:left" id="cmd-copy">Copy</button>
        <div style="float:clear" id="cmd-line">
          <p>vpxenc --codec=vp9</p>
          <p rv-class-selected="ui.in.lag_in_frames"
             rv-show="model.lag_in_frames.enabled">--lag-in-frames={model.lag_in_frames.value}</p>
          <p rv-class-selected="ui.in.debug"
             rv-show="model.debug">--debug</p>
          <p rv-class-selected="ui.in.verbose"
             rv-show="model.verbose">--verbose</p>
          <p rv-class-selected="ui.in.psnr"
             rv-show="model.psnr">--psnr</p>
          <p rv-class-selected="ui.in.quiet"
             rv-show="model.quiet">--quiet</p>
          <p rv-class-selected="ui.frame_parallel"
             rv-show="model.frame_parallel">--frame-parallel</p>
          <p rv-on-click="model.passes_cycle"
             rv-class-selected="ui.in.passes"
             rv-inside="ui.in.passes">--passes={model.passes}</p>
          <p rv-on-click="model.end_usage_cycle"
             rv-class-selected="ui.in.end_usage"
             rv-inside="ui.in.end_usage">--end-usage={model.end_usage}</p>
          <p data-control-id="target-bitrate"
             rv-class-selected="ui.in.target_bitrate"
             rv-show="model.end_usage | in vbr cbr cq"
             rv-inside="ui.in.target_bitrate">--target-bitrate={model.target_bitrate}</p>
          <p data-control-id="undershoot-pct"
             rv-class-selected="ui.in.undershoot_pct"
             rv-show="model.enable_undershoot_pct"
             rv-inside="ui.in.undershoot_pct">--undershoot-pct={model.undershoot_pct}</p>
          <p data-control-id="overshoot-pct"
             rv-class-selected="ui.in.overshoot_pct"
             rv-show="model.enable_overshoot_pct"
             rv-inside="ui.in.overshoot_pct">--overshoot-pct={model.overshoot_pct}</p>
          <p data-control-id="cq-level"
             rv-class-selected="ui.in.cq_level"
             rv-show="model.end_usage | in cq q"
             rv-inside="ui.in.cq_level">--cq-level={model.cq_level}</p>
          <p rv-on-click="model.quality_cycle"
             rv-inside="ui.in.speed"
             rv-class-selected="ui.in.speed">--{model.quality} <span rv-show="model.quality | in rt good">--cpu-used={model.speed}</span></p>
          <p rv-class-selected="ui.in.kf_min_dist"
             rv-show="model.kf_min_dist.enabled">--kf-min-dist={model.kf_min_dist.value}</p>
          <p rv-class-selected="ui.in.kf_max_dist"
             rv-show="model.kf_max_dist.enabled">--kf-max-dist={model.kf_max_dist.value}</p>
          <p data-control-id="min-q"
             rv-class-selected="ui.in.min_q"
             rv-show="model.min_q.enabled"
             rv-inside="ui.in.min_q">--min-q={model.min_q.value}</p>
          <p data-control-id="max-q"
             rv-class-selected="ui.in.max_q"
             rv-show="model.max_q.enabled"
             rv-inside="ui.in.max_q">--max-q={model.max_q.value}</p>
          <p rv-class-selected="ui.in.auto_alt_ref"
             rv-show="model.auto_alt_ref">--auto-alt-ref=1</p>
          <p rv-class-selected="ui.in.auto_alt_ref"
             rv-hide="model.auto_alt_ref">--auto-alt-ref=0</p>
          <p rv-class-selected="ui.in.tiles"
             rv-show="model.tiles.enabled">--tile-rows={model.tiles.rows} --tile-cols={model.tiles.cols}</p>
          <p rv-class-selected="ui.in.aq"
             rv-show="model.aq | in 1 2 3">--aq-mode={model.aq}</p>
          <p rv-show="model.input.skip.enabled"
             rv-class-selected="ui.in.input_skip">--skip={model.input.skip.value}</p>
          <p rv-show="model.input.limit.enabled"
             rv-class-selected="ui.in.input_limit">--limit={model.input.limit.value}</p>
          <p rv-show="model.fps.enabled"
             rv-class-selected="ui.in.fps">--fps={model.fps.num}/{model.fps.den}</p>

          <p rv-show="model.input.format | in i420 i422 i444 yv12">--{model.input.format} --width={model.input.width} --height={model.input.height}</p>
          <p rv-show="model.input.type | eq file"
             rv-class-selected="ui.in.input_src">{model.input.name}<span rv-show="model.input.format | in i420 i422 i444 yv12">.yuv</span><span rv-show="model.input.format | in y4m">.y4m</span>
          </p>
          <p rv-show="model.input.type | eq stdin"
             rv-class-selected="ui.in.input_src">-</p>

          <p rv-show="model.output.format | eq ivf"
             rv-class-selected="ui.in.output_format">--ivf</p>
          <p rv-show="model.output.type | eq file"
             rv-class-selected="ui.in.output_dst">-o {model.output.name}.{model.output.format}</p>
          <p rv-show="model.output.type | eq stdout"
             rv-class-selected="ui.in.output_dst">-o -</p>
        </div>
      </div>

      <div style="float:left">
        <div class="section">
          <div class="title">Passes</div>
          <div class="body" rv-inside="ui.in.passes">
            <label><input type="radio" name="passes" value="1" rv-checked="model.passes"/>Single</label>
            <label><input type="radio" name="passes" value="2" rv-checked="model.passes"/>Multi</label>
          </div>
        </div>

        <div class="section">
          <div class="title">Usage</div>
          <div class="body" rv-inside="ui.in.end_usage">
            <label><input type="radio"
                          name="end-usage"
                          value="vbr"
                          rv-checked="model.end_usage"/>VBR (Variable Bitrate)</label><br/>
            <label><input type="radio"
                          name="end-usage"
                          value="cbr"
                          rv-checked="model.end_usage"/>CBR (Constant Bitrate)</label><br/>
            <label><input type="radio"
                          name="end-usage"
                          value="cq"
                          rv-checked="model.end_usage"/>CQ (Constained Quality)</label><br/>

            <label><input type="radio"
                          name="end-usage"
                          value="q"
                          rv-checked="model.end_usage"/>Q (Constant Quality)</label>
          </div>
        </div>

        <div class="section">
          <div class="title">Speed</div>
          <div class="body" rv-inside="ui.in.speed">
            <label><input type="radio" name="quality" value="rt" rv-checked="model.quality"/>Real Time</label>
            <label><input type="radio" name="quality" value="good" rv-checked="model.quality"/>Good</label>
            <label><input type="radio" name="quality" value="best" rv-checked="model.quality"/>Best</label><br/>
            <input type="range" min="0" max="10" rv-input="model.speed" rv-enabled="model.quality | in rt good"/>
            <span class="value" rv-text="model.speed"></span>
          </div>
        </div>

        <div class="section">
          <div class="title">Rate Control</div>
          <table class="body" role="presentation">
            <tr rv-inside="ui.in.target_bitrate">
              <td></td>
              <td>Bitrate</td>
              <td><input id="target-bitrate" type="text"
                         rv-input="model.target_bitrate"
                         rv-enabled="model.end_usage | in vbr cbr cq"/></td>
              <td>kbps</td>
            </tr>
            <tr rv-inside="ui.in.undershoot_pct">
              <td><input id="enable-undershoot-pct" type="checkbox"
                         rv-checked="model.enable_undershoot_pct"/></td>
              <td><label for="enable-undershoot-pct">Undershoot</label></td>
              <td><input id="undershoot-pct" type="text"
                         rv-input="model.undershoot_pct"
                         rv-enabled="model.enable_undershoot_pct"/></td>
              <td>%</td>
            </tr>
            <tr rv-inside="ui.in.overshoot_pct">
              <td><input id="enable-overshoot-pct" type="checkbox"
                         rv-checked="model.enable_overshoot_pct"/></td>
              <td><label for="enable-overshoot-pct">Overshoot</label></td>
              <td><input id="overshoot-pct" type="text"
                         rv-input="model.overshoot_pct"
                         rv-enabled="model.enable_overshoot_pct"/></td>
              <td>%</td>
            </tr>
          </table>
        </div>

        <div class="section">
          <div class="title">Quantization</div>
          <table class="body" role="presentation">
            <tr rv-inside="ui.in.cq_level">
              <td></td>
              <td>Main Quantizer</td>
              <td><input id="cq-level" type="range"
                         min="0" max="63"
                         rv-input="model.cq_level" 
                         rv-enabled="model.end_usage | in cq q"/></td>
              <td class="value" rv-text="model.cq_level"></td>
            </tr>
            <tr rv-inside="ui.in.min_q">
              <td><input id="enable-min-q" type="checkbox" rv-checked="model.min_q.enabled"/></td>
              <td><label for="enable-min-q">Min Quantizer</label></td>
              <td><input id="min-q" type="range" 
                         min="0" max="63" 
                         rv-enabled="model.min_q.enabled" 
                         rv-input="model.min_q.value"/></td>
              <td class="value" rv-text="model.min_q.value"></td>
            </tr>
            <tr rv-inside="ui.in.max_q">
              <td><input id="enable-max-q" type="checkbox" rv-checked="model.max_q.enabled"/></td>
              <td><label for="enable-max-q">Max Quantizer</label></td>
              <td><input id="max-q" type="range" 
                         min="0" max="63" 
                         rv-enabled="model.max_q.enabled" 
                         rv-input="model.max_q.value"/></td>
              <td class="value" rv-text="model.max_q.value"></td>
            </tr>
          </table>
        </div>

        <div class="section">
          <div class="title">Adaptive Quantization</div>
          <div class="body" rv-inside="ui.in.aq">
            <label><input type="radio" name="aq" value="0" rv-checked="model.aq"/>Off</label><br/>
            <label><input type="radio" name="aq" value="1" rv-checked="model.aq"/>Variance</label><br/>
            <label><input type="radio" name="aq" value="2" rv-checked="model.aq"/>Complexity</label><br/>
            <label><input type="radio" name="aq" value="3" rv-checked="model.aq"/>Cyclic refresh</label>
          </div>
        </div>

        <div class="section">
          <div class="title">Tiles</div>
          <div class="body" rv-inside="ui.in.tiles">
            <label><input type="checkbox" rv-checked="model.tiles.enabled"/>Enable</label>
              <select rv-value="model.tiles.rows" rv-enabled="model.tiles.enabled">
                <option value="0">1</option>
                <option value="1">2</option>
                <option value="2">4</option>
              </select> &times;
              <select rv-value="model.tiles.cols" rv-enabled="model.tiles.enabled">
                <option value="0">1</option>
                <option value="1">2</option>
                <option value="2">4</option>
                <option value="3">8</option>
                <option value="4">16</option>
                <option value="5">32</option>
                <option value="6">64</option>
              </select>
          </div> 
        </div>

        <div class="section">
          <div class="title">Key Frames</div>
          <div class="body">
            <div rv-inside="ui.in.kf_min_dist">
              <label><input type="checkbox" rv-checked="model.kf_min_dist.enabled"/>Min Distance</label>
              <input type="text" rv-enabled="model.kf_min_dist.enabled" rv-input="model.kf_min_dist.value"/>frames
            </div>
            <div rv-inside="ui.in.kf_max_dist">
              <label><input type="checkbox" rv-checked="model.kf_max_dist.enabled"/>Max Distance</label>
              <input type="text" rv-enabled="model.kf_max_dist.enabled" rv-input="model.kf_max_dist.value"/>frames
            </div>
          </div>
        </div>

        <div class="section">
          <div class="title">Alt Reference Frames</div>
          <div class="body" rv-inside="ui.in.auto_alt_ref">
            <label><input type="checkbox" rv-checked="model.auto_alt_ref"/>Enable</label>
          </div>
        </div>
      </div>

      <div style="float:left;margin-left:40px">
        <div class="section">
          <div class="title">Input</div>
          <div class="body">

            Format
            <div class="indent">
              <label><input type="radio"
                            name="input_format"
                            value="y4m"
                            rv-checked="model.input.format"/>Y4M</label><br/>
              <div>
                <div style="float:left;width:45%;overflow:hidden;padding:0;margin:0px;border-right:solid black 1px">
                  <label><input type="radio"
                                name="input_format"
                                value="i420"
                                rv-checked="model.input.format"/>YUV 4:2:0</label><br/>
                  <label><input type="radio"
                                name="input_format"
                                value="i422"
                                rv-checked="model.input.format"/>YUV 4:2:2</label><br/>
                  <label><input type="radio"
                                name="input_format"
                                value="i444"
                                rv-checked="model.input.format"/>YUV 4:4:4</label><br/>
                  <label><input type="radio"
                                name="input_format"
                                value="yv12"
                                rv-checked="model.input.format"/>YV12</label>
                </div>

                <div style="float:left;width:50%;overflow:hidden;margin-left:5px;margin-left:5px;margin-top:25px">
                  <input style="width:40px" type="text"
                         rv-input="model.input.width"
                         rv-enabled="model.input.format | in i420 i422 i444 yv12"/> &times; 
                  <input style="width:40px" type="text"
                         rv-input="model.input.height"
                         rv-enabled="model.input.format | in i420 i422 i444 yv12"/>
                </div>

                <div style="clear:both"></div>
              </div>
            </div>

            Source
            <div class="indent" rv-inside="ui.in.input_src">
              <label><input type="radio" name="input-type" value="file"
                            rv-checked="model.input.type"/>File</label>
                <input type="text" rv-input="model.input.name"/><br/>
              <label><input type="radio" name="input-type" value="stdin"
                            rv-checked="model.input.type"/>STDIN</label><br/>
            </div>

            Frames
            <div class="indent">
              <div rv-inside="ui.in.input_skip">
                <label><input type="checkbox" rv-checked="model.input.skip.enabled"/>Skip</label>
                <input type="text" rv-input="model.input.skip.value" rv-enabled="model.input.skip.enabled"/>frames
              </div>

              <div rv-inside="ui.in.input_limit">
                <label><input type="checkbox" rv-checked="model.input.limit.enabled"/>Limit</label>
                <input type="text" rv-input="model.input.limit.value" rv-enabled="model.input.limit.enabled"/>frames
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="title">Output</div>
          <div class="body">
            Format
            <div class="indent" rv-inside="ui.in.output_format">
              <label><input type="radio"
                            name="output_format"
                            value="webm"
                            rv-checked="model.output.format"/>WebM</label><br/>
              <label><input type="radio"
                            name="output_format"
                            value="ivf"
                            rv-checked="model.output.format"/>IVF</label>
            </div>
            Destination
            <div class="indent" rv-inside="ui.in.output_dst">
              <label><input type="radio" name="output-type" value="file"
                            rv-checked="model.output.type"/>File</label>
                <input type="text" rv-input="model.output.name"/><br/>
              <label><input type="radio" name="output-type" value="stdout"
                            rv-checked="model.output.type"/>STDOUT</label>
            </div>
          </div>
        </div>
        <div class="section">
          <div class="title">Miscellaneous</div>
          <div class="body">
            <label rv-inside="ui.in.debug">
              <input type="checkbox" rv-checked="model.debug"/>Debug mode
            </label><br/>
            <label rv-inside="ui.in.verbose">
              <input type="checkbox" rv-checked="model.verbose"/>Show encoder paramters
            </label><br/>
            <label rv-inside="ui.in.psnr">
              <input type="checkbox" rv-checked="model.psnr"/>Show PSNR in status line
            </label><br/>
            <label rv-inside="ui.in.quiet">
              <input type="checkbox" rv-checked="model.quiet"/>Do not print encode progress
            </label><br/>
            <label rv-inside="ui.parallel.frame">
              <input type="checkbox" rv-checked="model.frame_parallel"/>Enable frame parallel decodability
            </label>
            <div rv-inside="ui.in.lag_in_frames">
              <label><input type="checkbox" rv-checked="model.lag_in_frames.enabled"/>Lag-in</label>
              <input type="text" rv-enabled="model.lag_in_frames.enabled" rv-input="model.lag_in_frames.value"/> frames
            </div>
            <div rv-inside="ui.in.fps">
              <label><input type="checkbox" rv-checked="model.fps.enabled"/>FPS</label>
              <input style="width:30px" type="text" rv-enabled="model.fps.enabled" rv-input="model.fps.num"/> /
              <input style="width:30px" type="text" rv-enabled="model.fps.enabled" rv-input="model.fps.den"/>
            </div>
          </div>
        </div>
        <button id="reset">Reset</button>
      </div>
    </div>
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="js/ZeroClipboard.min.js"></script>
    <script type="text/javascript" src="js/rivets.min.js"></script>
    
    <script>
      var ui = {
        in: {
          passes: false,
          end_usage: false,
          target_bitrate: false,
          undershoot_pct: false,
          overshoot_pct: false,
          cq_level: false,
          speed: false,
          aq: false,
          tiles: false,
          debug: false,
          verbose: false,
          psnr: false,
          quiet: false,
          frame_parallel: false,
          min_q: false,
          max_q: false,
          kf_min_dist: false,
          kf_max_dist: false,
          auto_alt_ref: false,
          lag_in_frames: false,
          input_skip: false,
          input_limit: false,
          input_src: false,
          output_format: false,
          output_dst: false,
          fps: false
        }
      };

      function getParamCycle(param, values) {
        return function(event, models) {
          var model = models.model;
          model[param] = values[($.inArray(model[param], values) + 1) % values.length];
        };
      }

      var m = {codec:'vp9', 
               debug: false,
               verbose: false,
               psnr: false,
               quet: false,
               frame_parallel: false,
               input: {format: 'y4m', // 'y4m', 'i420', 'i422', 'i444'
                       width: 640,
                       height: 480,
                       type: 'file', // 'file', 'stdin'
                       name: 'input',
                       limit: {value: 100, enabled: false},
                       skip: {value: 0, enabled: false}},
               output: {format: 'webm', // 'ivf', 'webm'
                        type: 'file', //  'file', 'stdout'
                        name: 'output'},
               passes: 2,            // 1, 2
               passes_cycle: getParamCycle('passes', [1, 2]),
               end_usage: 'vbr',     // 'vbr', 'cbr', 'cq', 'q'
               end_usage_cycle: getParamCycle('end_usage', ['vbr', 'cbr', 'cq', 'q']),
               quality: 'good',      // 'rt', 'good', 'best'
               quality_cycle: getParamCycle('quality', ['rt', 'good', 'best']),
               speed: 1,             // 1, 2, 3, ..., 10
               target_bitrate: 600,  // > 0
               enable_undershoot_pct: false,
               undershoot_pct: 10,
               enable_overshoot_pct: false,
               overshoot_pct: 10,
               cq_level: 10,         // 0, 1, 2, ..., 63
               aq: 0,                // 0, 1, 2, 3
               tiles: {rows: 0, cols:0, enabled: false},
               auto_alt_ref: 1,
               kf_min_dist: {value: 0, enabled: false},
               kf_max_dist: {value: 9999, enabled: false},
               min_q: {value: 0, enabled: false},
               max_q: {value: 63, enabled: false},
               lag_in_frames: {value: 25, enabled: false},
               fps: {num:30, den:1, enabled:false},
             };

      var mcopy = $.extend(true, {}, m);

      $('#reset').on('click', function() {
        $.extend(m, mcopy);
      });

      rivets.binders.inside = {
        publishes: true,
        bind: function(el) {
          var self = this;

          this.enter_callback = function() {
            self.observer.publish(1);
          }

          this.leave_callback = function() {
            self.observer.publish(0);
          }

          $(el).on('mouseenter', this.enter_callback);
          $(el).on('mouseleave', this.leave_callback);
        },

        unbind: function(el) {
          $(el).off('mouseenter', this.enter_callback)
          $(el).off('mouseleave', this.leave_callback);
        },
      };

      rivets.binders.input = {
        publishes: true,
        routine: rivets.binders.value.routine,
        bind: function (el) {
          $(el).on('input change', this.publish);
        },
        unbind: function (el) {
          $(el).off('input change', this.publish);
        }
      };

      rivets.formatters.eq = function (value, args) {
        return value === args;
      };

      rivets.formatters.in = function (value, args) {
        return $.inArray(value, arguments, 1) !== -1;
      };

      var view = rivets.bind($('#panel'), {
        model: m,
        ui: ui
      });

      $('#cmd').css('visibility', 'visible');

      var textControl = null;

      $('#panel [data-control-id]:not([data-control-id=""])')
        .on('mouseenter', function(event) {
          var id = $(event.target).attr('data-control-id');
          textControl = $('#' + id);
        })
        .on('mouseleave', function (event) {
          textControl = null;
        });
      
      var rangeControl = null;

      $('#panel input[type=range]')
        .on('mouseenter', function(event){
          rangeControl = $(event.target);
        })
        .on('mouseleave', function(event ){
          rangeControl = null;
        });

      $(document).on('keydown', function(event) {
        if (rangeControl) {
          var val = parseInt(rangeControl.val());
          if (event.keyCode === 38) {
            rangeControl.val(val + 1).trigger('change');
            event.preventDefault();
          } else if (event.keyCode === 40) {
            rangeControl.val(val - 1).trigger('change');
            event.preventDefault();
          }
        }
        
        if (textControl) {  
          var delta = (event.ctrlKey && event.shiftKey) ? 100 : (event.shiftKey ? 10 : 1);
          var val = parseInt(textControl.val());
          if (event.keyCode === 38) {
            textControl.val(val + delta).trigger('change');
            event.preventDefault();
          } else if (event.keyCode === 40) {
            textControl.val(val - delta).trigger('change');
            event.preventDefault();
          } 
        }
      });

      $(document).on('mousewheel', function(event) {
        if (rangeControl) {
          var delta = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var val = parseInt(rangeControl.val());
          rangeControl.val(val + delta).trigger('change');
          event.preventDefault();
        }

        if (textControl) {  
          var delta = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var val = parseInt(textControl.val());
          textControl.val(val + delta).trigger('change');
          event.preventDefault();
        }
      });

      var client = new ZeroClipboard($('#cmd-copy'));
      client.on('copy', function(event) {
        //var cmd = $('#cmd').children(":visible").text(); //.replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        var cmd = $('#cmd-line').children(":visible").map(function(){ return $(this).text() }).get().join(' ').replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        console.log(cmd);
        var clipboard = event.clipboardData;
        clipboard.setData("text/plain", cmd);
      });
    </script>
  </body>
</html>
