<!DOCTYPE html>
<html>
  <head>
    <title>libvpx cli generator</title>
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        border: 0;
      }

      input {
        vertical-align:middle;
      }

      input[type='radio'] {
        cursor: pointer; 
      }

      label { 
        cursor: pointer; 
      }

      .section {
        margin-bottom: 5px;
        margin-left: 10px;
      }

      .section .title {
        font-weight: bold;
      }

      .section .body {
        margin-left: 5px;
      }

      .selected {
        padding-bottom: 1px;
        border-bottom: 1px dashed;
      }

      .indent {
        margin-left: 10px;
      }

      .value {
        font-size: 8pt;
      }

      #cmd {
        background-color:black;
        padding-top:10px;
        padding-bottom:10px;
        padding-left:5px;
        margin-bottom: 10px;
        height: 3em;
      }

      #cmd-copy {
        margin-right: 20px;
      }

      #cmd-line {
        font-size:12pt;
        font-family:monospace;
        color:white;
      }

      #panel p {
        display: inline;
      }

      [rv-on-click]:not([rv-on-click=""]) {
        cursor: pointer;
      }

    </style>
  </head>
  <body>
    <div id="panel">
      <div id="cmd" style="visibility:hidden">
        <button style="float:left" id="cmd-copy">Copy</button>
        <div style="float:clear" id="cmd-line">
          <p>vpxenc --codec=vp9</p>
          <p rv-class-selected="ui.lag_in_frames_inside"
             rv-show="model.enable_lag_in_frames">--lag-in-frames={model.lag_in_frames}</p>
          <p rv-class-selected="ui.debug_inside"
             rv-show="model.debug">--debug</p>
          <p rv-class-selected="ui.verbose_inside"
             rv-show="model.verbose">--verbose</p>
          <p rv-class-selected="ui.psnr_inside"
             rv-show="model.psnr">--psnr</p>
          <p rv-class-selected="ui.quiet_inside"
             rv-show="model.quiet">--quiet</p>
          <p rv-class-selected="ui.frame_parallel"
             rv-show="model.frame_parallel">--frame-parallel</p>
          <p rv-on-click="model.passes_cycle"
             rv-class-selected="ui.passes_inside"
             rv-inside="ui.passes_inside">--passes={model.passes}</p>
          <p rv-on-click="model.end_usage_cycle"
             rv-class-selected="ui.end_usage_inside"
             rv-inside="ui.end_usage_inside">--end-usage={model.end_usage}</p>
          <p data-control-id="target-bitrate"
             rv-class-selected="ui.target_bitrate_inside"
             rv-show="model.end_usage | in vbr cbr cq"
             rv-inside="ui.target_bitrate_inside">--target-bitrate={model.target_bitrate}</p>
          <p data-control-id="undershoot-pct"
             rv-class-selected="ui.undershoot_pct_inside"
             rv-show="model.enable_undershoot_pct"
             rv-inside="ui.undershoot_pct_inside">--undershoot-pct={model.undershoot_pct}</p>
          <p data-control-id="overshoot-pct"
             rv-class-selected="ui.overshoot_pct_inside"
             rv-show="model.enable_overshoot_pct"
             rv-inside="ui.overshoot_pct_inside">--overshoot-pct={model.overshoot_pct}</p>
          <p data-control-id="cq-level"
             rv-class-selected="ui.cq_level_inside"
             rv-show="model.end_usage | in cq q"
             rv-inside="ui.cq_level_inside">--cq-level={model.cq_level}</p>
          <p rv-on-click="model.quality_cycle"
             rv-inside="ui.speed_inside"
             rv-class-selected="ui.speed_inside">--{model.quality} <span rv-show="model.quality | in rt good">--cpu-used={model.speed}</span></p>
          <p rv-class-selected="ui.kf_min_dist_inside"
             rv-show="model.enable_kf_min_dist">--kf-min-dist={model.kf_min_dist}</p>
          <p rv-class-selected="ui.kf_max_dist_inside"
             rv-show="model.enable_kf_max_dist">--kf-max-dist={model.kf_max_dist}</p>
          <p data-control-id="min-q"
             rv-class-selected="ui.min_q_inside"
             rv-show="model.enable_min_q"
             rv-inside="ui.min_q_inside">--min-q={model.min_q}</p>
          <p data-control-id="max-q"
             rv-class-selected="ui.max_q_inside"
             rv-show="model.enable_max_q"
             rv-inside="ui.max_q_inside">--max-q={model.max_q}</p>
          <p rv-class-selected="ui.auto_alt_ref_inside"
             rv-show="model.auto_alt_ref">--auto-alt-ref=1</p>
          <p rv-class-selected="ui.auto_alt_ref_inside"
             rv-hide="model.auto_alt_ref">--auto-alt-ref=0</p>
          <p rv-class-selected="ui.tiles_inside"
             rv-show="model.enable_tiles">--tile-rows={model.tile_rows} --tile-cols={model.tile_cols}</p>
          <p rv-class-selected="ui.aq_inside"
             rv-show="model.aq | in 1 2 3">--aq-mode={model.aq}</p>
          <p rv-show="model.input.enable_skip">--skip={model.input.skip}</p>
          <p rv-show="model.input.enable_limit">--limit={model.input.limit}</p>
          <p rv-class-selected="ui.input_inside"
             rv-show="model.input.format | in i420 i422 i444 yv12">--{model.input.format} --width={model.input.width} --height={model.input.height} {model.input.name}.yuv</p>
          <p rv-class-selected="ui.input_inside"
             rv-show="model.input.format | in y4m">{model.input.name}.y4m</p>
          <p rv-class-selected="ui.output_inside"><span rv-show="model.output.format | eq ivf">--ivf</span> -o {model.output.name}.{model.output.format}</p>
        </div>
      </div>

      <div style="float:left">
        <div class="section">
          <div class="title">Passes</div>
          <div class="body" rv-inside="ui.passes_inside">
            <label><input type="radio" name="passes" value="1" rv-checked="model.passes"/>Single</label>
            <label><input type="radio" name="passes" value="2" rv-checked="model.passes"/>Multi</label>
          </div>
        </div>

        <div class="section">
          <div class="title">Usage</div>
          <div class="body" rv-inside="ui.end_usage_inside">
            <label><input type="radio"
                          name="end-usage"
                          value="vbr"
                          rv-checked="model.end_usage"/>VBR (Variable Bitrate)</label><br/>
            <label><input type="radio"
                          name="end-usage"
                          value="cbr"
                          rv-checked="model.end_usage"/>CBR (Constant Bitrate)</label><br/>
            <label><input type="radio"
                          name="end-usage"
                          value="cq"
                          rv-checked="model.end_usage"/>CQ (Constained Quality)</label><br/>

            <label><input type="radio"
                          name="end-usage"
                          value="q"
                          rv-checked="model.end_usage"/>Q (Constant Quality)</label>
          </div>
        </div>

        <div class="section">
          <div class="title">Speed</div>
          <div class="body" rv-inside="ui.speed_inside">
            <label><input type="radio" name="quality" value="rt" rv-checked="model.quality"/>Real Time</label>
            <label><input type="radio" name="quality" value="good" rv-checked="model.quality"/>Good</label>
            <label><input type="radio" name="quality" value="best" rv-checked="model.quality"/>Best</label><br/>
            <input type="range" min="0" max="10" rv-input="model.speed" rv-enabled="model.quality | in rt good"/>
            <span class="value" rv-text="model.speed"></span>
          </div>
        </div>

        <div class="section">
          <div class="title">Rate Control</div>
          <table class="body" role="presentation">
            <tr rv-inside="ui.target_bitrate_inside">
              <td></td>
              <td>Bitrate</td>
              <td><input id="target-bitrate" type="text"
                         rv-input="model.target_bitrate"
                         rv-enabled="model.end_usage | in vbr cbr cq"/></td>
              <td>kbps</td>
            </tr>
            <tr rv-inside="ui.undershoot_pct_inside">
              <td><input id="enable-undershoot-pct" type="checkbox"
                         rv-checked="model.enable_undershoot_pct"/></td>
              <td><label for="enable-undershoot-pct">Undershoot</label></td>
              <td><input id="undershoot-pct" type="text"
                         rv-input="model.undershoot_pct"
                         rv-enabled="model.enable_undershoot_pct"/></td>
              <td>%</td>
            </tr>
            <tr rv-inside="ui.overshoot_pct_inside">
              <td><input id="enable-overshoot-pct" type="checkbox"
                         rv-checked="model.enable_overshoot_pct"/></td>
              <td><label for="enable-overshoot-pct">Overshoot</label></td>
              <td><input id="overshoot-pct" type="text"
                         rv-input="model.overshoot_pct"
                         rv-enabled="model.enable_overshoot_pct"/></td>
              <td>%</td>
            </tr>
          </table>
        </div>

        <div class="section">
          <div class="title">Quantization</div>
          <table class="body" role="presentation">
            <tr rv-inside="ui.cq_level_inside">
              <td></td>
              <td>Main Quantizer</td>
              <td><input id="cq-level" type="range"
                         min="0" max="63"
                         rv-input="model.cq_level" 
                         rv-enabled="model.end_usage | in cq q"/></td>
              <td class="value" rv-text="model.cq_level"></td>
            </tr>
            <tr rv-inside="ui.min_q_inside">
              <td><input id="enable-min-q" type="checkbox" rv-checked="model.enable_min_q"/></td>
              <td><label for="enable-min-q">Min Quantizer</label></td>
              <td><input id="min-q" type="range" 
                         min="0" max="63" 
                         rv-enabled="model.enable_min_q" 
                         rv-input="model.min_q"/></td>
              <td class="value" rv-text="model.min_q"></td>
            </tr>
            <tr rv-inside="ui.max_q_inside">
              <td><input id="enable-max-q" type="checkbox" rv-checked="model.enable_max_q"/></td>
              <td><label for="enable-max-q">Max Quantizer</label></td>
              <td><input id="max-q" type="range" 
                         min="0" max="63" 
                         rv-enabled="model.enable_max_q" 
                         rv-input="model.max_q"/></td>
              <td class="value" rv-text="model.max_q"></td>
            </tr>
          </table>
        </div>

        <div class="section">
          <div class="title">Adaptive Quantization</div>
          <div class="body" rv-inside="ui.aq_inside">
            <label><input type="radio" name="aq" value="0" rv-checked="model.aq"/>Off</label><br/>
            <label><input type="radio" name="aq" value="1" rv-checked="model.aq"/>Variance</label><br/>
            <label><input type="radio" name="aq" value="2" rv-checked="model.aq"/>Complexity</label><br/>
            <label><input type="radio" name="aq" value="3" rv-checked="model.aq"/>Cyclic refresh</label>
          </div>
        </div>

        <div class="section">
          <div class="title">Tiles</div>
          <div class="body" rv-inside="ui.tiles_inside">
            <label><input type="checkbox" rv-checked="model.enable_tiles"/>Enable</label>
              <select rv-value="model.tile_rows" rv-enabled="model.enable_tiles">
                <option value="0">1</option>
                <option value="1">2</option>
                <option value="2">4</option>
              </select> &times;
              <select rv-value="model.tile_cols" rv-enabled="model.enable_tiles">
                <option value="0">1</option>
                <option value="1">2</option>
                <option value="2">4</option>
                <option value="3">8</option>
                <option value="4">16</option>
                <option value="5">32</option>
                <option value="6">64</option>
              </select>
          </div> 
        </div>

        <div class="section">
          <div class="title">Key Frames</div>
          <div class="body">
            <div rv-inside="ui.kf_min_dist_inside">
              <label><input type="checkbox" rv-checked="model.enable_kf_min_dist"/>Min Distance</label>
              <input type="text" rv-enabled="model.enable_kf_min_dist" rv-input="model.kf_min_dist"/>frames
            </div>
            <div rv-inside="ui.kf_max_dist_inside">
              <label><input type="checkbox" rv-checked="model.enable_kf_max_dist"/>Max Distance</label>
              <input type="text" rv-enabled="model.enable_kf_max_dist" rv-input="model.kf_max_dist"/>frames
            </div>
          </div>
        </div>

        <div class="section">
          <div class="title">Alt Reference Frames</div>
          <div class="body" rv-inside="ui.auto_alt_ref_inside">
            <label><input type="checkbox" rv-checked="model.auto_alt_ref"/>Enable</label>
          </div>
        </div>
      </div>

      <div style="float:left;margin-left:40px">
        <div class="section">
          <div class="title">Input</div>
          <div class="body" rv-inside="ui.input_inside">
            <label><input type="radio"
                          name="input_format"
                          value="y4m"
                          rv-checked="model.input.format"/>Y4M</label><br/>
            <div>
              <div>
                <label><input type="radio"
                              name="input_format"
                              value="i420"
                              rv-checked="model.input.format"/>YUV 4:2:0</label><br/>
                <label><input type="radio"
                              name="input_format"
                              value="i422"
                              rv-checked="model.input.format"/>YUV 4:2:2</label><br/>
                <label><input type="radio"
                              name="input_format"
                              value="i444"
                              rv-checked="model.input.format"/>YUV 4:4:4</label><br/>
                <label><input type="radio"
                              name="input_format"
                              value="yv12"
                              rv-checked="model.input.format"/>YV12</label><br/>
              </div>
            
              <div>
                Size: <input type="text"
                       rv-input="model.input.width"
                       rv-enabled="model.input.format | in i420 i422 i444 yv12"/> &times; 
                <input type="text"
                       rv-input="model.input.height"
                       rv-enabled="model.input.format | in i420 i422 i444 yv12"/>
              </div>
            </div>


            <div>
              <label><input type="checkbox" rv-checked="model.input.enable_skip"/>Skip</label>
              <input type="text" rv-input="model.input.skip" rv-enabled="model.input.enable_skip"/>frames
            </div>

            <div>
              <label><input type="checkbox" rv-checked="model.input.enable_limit"/>Limit</label>
              <input type="text" rv-input="model.input.limit" rv-enabled="model.input.enable_limit"/>frames
            </div>

            Filename <input type="text" rv-input="model.input.name"/>
          </div>
        </div>

        <div class="section">
          <div class="title">Output</div>
          <div class="body" rv-inside="ui.output_inside">
            <label><input type="radio"
                          name="output_format"
                          value="webm"
                          rv-checked="model.output.format"/>WebM</label><br/>
            <label><input type="radio"
                          name="output_format"
                          value="ivf"
                          rv-checked="model.output.format"/>IVF</label><br/>
            Filename <input type="text" rv-input="model.output.name"/>
          </div>
        </div>
        <div class="section">
          <div class="title">Miscellaneous</div>
          <div class="body">
            <label rv-inside="ui.debug_inside">
              <input type="checkbox" rv-checked="model.debug"/>Debug mode
            </label><br/>
            <label rv-inside="ui.verbose_inside">
              <input type="checkbox" rv-checked="model.verbose"/>Show encoder paramters
            </label><br/>
            <label rv-inside="ui.psnr_inside">
              <input type="checkbox" rv-checked="model.psnr"/>Show PSNR in status line
            </label><br/>
            <label rv-inside="ui.quiet_inside">
              <input type="checkbox" rv-checked="model.quiet"/>Do not print encode progress
            </label><br/>
            <label rv-inside="ui.frame_parallel">
              <input type="checkbox" rv-checked="model.frame_parallel"/>Enable frame parallel decodability
            </label>
            <div rv-inside="ui.lag_in_frames_inside">
              <label><input type="checkbox" rv-checked="model.enable_lag_in_frames"/>Lag-in </label>
              <input type="text" rv-enabled="model.enable_lag_in_frames" rv-input="model.lag_in_frames"/> frames
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="js/ZeroClipboard.min.js"></script>
    <script type="text/javascript" src="js/rivets.min.js"></script>
    
    <script>
      var ui = {
        passes_inside: false,
        end_usage_inside: false,
        target_bitrate_inside: false,
        undershoot_pct_inside: false,
        overshoot_pct_inside: false,
        cq_level_inside: false,
        speed_inside: false,
        aq_inside: false,
        tiles_inside: false,
        debug_inside: false,
        verbose_inside: false,
        psnr_inside: false,
        quiet_inside: false,
        frame_parallel: false,
        min_q_inside: false,
        max_q_inside: false,
        kf_min_dist_inside: false,
        kf_max_dist_inside: false,
        auto_alt_ref_inside: false,
        lag_in_frames_inside: false,
        output_inside: false,
        input_inside:false,
      };

      function getParamCycle(param, values) {
        return function(event, models) {
          var model = models.model;
          model[param] = values[($.inArray(model[param], values) + 1) % values.length];
        };
      }

      var m = {codec:'vp9', 
               debug: false,
               verbose: false,
               psnr: false,
               quet: false,
               frame_parallel: false,
               input: {format: 'y4m', // 'y4m', 'i420', 'i422', 'i444'
                       width: 640,
                       height: 480,
                       name: 'input',
                       enable_limit: false,
                       limit: 100,
                       enable_skip: false,
                       skip: 0},
               output: {format: 'webm', // 'ivf', 'webm'
                        name: 'output'},
               passes: 2,            // 1, 2
               passes_cycle: getParamCycle('passes', [1, 2]),
               end_usage: 'vbr',     // 'vbr', 'cbr', 'cq', 'q'
               end_usage_cycle: getParamCycle('end_usage', ['vbr', 'cbr', 'cq', 'q']),
               quality: 'good',      // 'rt', 'good', 'best'
               quality_cycle: getParamCycle('quality', ['rt', 'good', 'best']),
               speed: 1,             // 1, 2, 3, ..., 10
               target_bitrate: 600,  // > 0
               enable_undershoot_pct: false,
               undershoot_pct: 10,
               enable_overshoot_pct: false,
               overshoot_pct: 10,
               cq_level: 10,         // 0, 1, 2, ..., 63
               aq: 0,                // 0, 1, 2, 3
               enable_tiles: false,
               tile_rows: 0,
               tile_cols: 0,
               auto_alt_ref: 1,
               enable_kf_min_dist: false,
               kf_min_dist: 0,
               enable_kf_max_dist: false,
               kf_max_dist: 9999,
               enable_min_q: false,
               min_q: 0,
               enable_max_q: false,
               max_q: 63,
               enable_lag_in_frames: false,
               lag_in_frames: 25
             };

      rivets.binders.inside = {
        publishes: true,
        bind: function(el) {
          var self = this;

          this.enter_callback = function() {
            self.observer.publish(1);
          }

          this.leave_callback = function() {
            self.observer.publish(0);
          }

          $(el).on('mouseenter', this.enter_callback);
          $(el).on('mouseleave', this.leave_callback);
        },

        unbind: function(el) {
          $(el).off('mouseenter', this.enter_callback)
          $(el).off('mouseleave', this.leave_callback);
        },
      };

      rivets.binders.input = {
        publishes: true,
        routine: rivets.binders.value.routine,
        bind: function (el) {
          $(el).on('input change', this.publish);
        },
        unbind: function (el) {
          $(el).off('input change', this.publish);
        }
      };

      rivets.formatters.eq = function (value, args) {
        return value === args;
      };

      rivets.formatters.in = function (value, args) {
        return $.inArray(value, arguments, 1) !== -1;
      };

      var view = rivets.bind($('#panel'), {
        model: m,
        ui: ui
      });

      $('#cmd').css('visibility', 'visible');

      var textControl = null;

      $('#panel [data-control-id]:not([data-control-id=""])')
        .on('mouseenter', function(event) {
          var id = $(event.target).attr('data-control-id');
          textControl = $('#' + id);
        })
        .on('mouseleave', function (event) {
          textControl = null;
        });
      
      var rangeControl = null;

      $('#panel input[type=range]')
        .on('mouseenter', function(event){
          rangeControl = $(event.target);
        })
        .on('mouseleave', function(event ){
          rangeControl = null;
        });

      $(document).on('keydown', function(event) {
        if (rangeControl) {
          var val = parseInt(rangeControl.val());
          if (event.keyCode === 38) {
            rangeControl.val(val + 1).trigger('change');
            event.preventDefault();
          } else if (event.keyCode === 40) {
            rangeControl.val(val - 1).trigger('change');
            event.preventDefault();
          }
        }
        
        if (textControl) {  
          var delta = (event.ctrlKey && event.shiftKey) ? 100 : (event.shiftKey ? 10 : 1);
          var val = parseInt(textControl.val());
          if (event.keyCode === 38) {
            textControl.val(val + delta).trigger('change');
            event.preventDefault();
          } else if (event.keyCode === 40) {
            textControl.val(val - delta).trigger('change');
            event.preventDefault();
          } 
        }
      });

      $(document).on('mousewheel', function(event) {
        if (rangeControl) {
          var delta = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var val = parseInt(rangeControl.val());
          rangeControl.val(val + delta).trigger('change');
          event.preventDefault();
        }

        if (textControl) {  
          var delta = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var val = parseInt(textControl.val());
          textControl.val(val + delta).trigger('change');
          event.preventDefault();
        }
      });

      var client = new ZeroClipboard($('#cmd-copy'));
      client.on('copy', function(event) {
        //var cmd = $('#cmd').children(":visible").text(); //.replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        var cmd = $('#cmd-line').children(":visible").map(function(){ return $(this).text() }).get().join(' ').replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        console.log(cmd);
        var clipboard = event.clipboardData;
        clipboard.setData("text/plain", cmd);
      });
    </script>
  </body>
</html>
