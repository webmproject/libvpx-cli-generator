<!DOCTYPE html>
<html>
  <head>
    <title>libvpx cli generator</title>
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        border: 0;
      }

      input {
        vertical-align:middle;
      }

      input[type='radio'] {
        cursor: pointer; 
      }
      label { 
        cursor: pointer; 
      }

      .section {
        margin-bottom: 5px;
        margin-left: 10px;
      }

      .section .title {
        font-weight: bold;
      }

      .section .body {
        margin-left: 5px;
      }

      .selected {
        padding-bottom: 1px;
        border-bottom: 1px dashed;
      }

      .indent {
        margin-left: 10px;
      }

      .value {
        font-size: 8pt;
      }

      #cmd {
        background-color:black;
        padding-top:10px;
        padding-bottom:10px;
        padding-left:5px;
        margin-bottom: 10px;
      }

      #cmd-copy {
        margin-right: 20px;
      }

      #cmd-line {
        font-size:12pt;
        font-family:monospace;
        color:white;
      }

      #panel p {
        display: inline;
      }

      [rv-on-click]:not([rv-on-click=""]) {
        cursor: pointer;
      }

    </style>
  </head>
  <body>
    <div id="panel">
      <div id="cmd" style="visibility:hidden">
        <button style="float:left" id="cmd-copy">Copy</button>
        <div style="float:clear" id="cmd-line">
          <p>vpxenc --codec=vp9</p>
          <p rv-class-selected="ui.debug_inside"
             rv-show="model.debug">--debug</p>
          <p rv-class-selected="ui.verbose_inside"
             rv-show="model.verbose">--verbose</p>
          <p rv-class-selected="ui.psnr_inside"
             rv-show="model.psnr">--psnr</p>
          <p rv-class-selected="ui.quiet_inside"
             rv-show="model.quiet">--quiet</p>
          <p rv-on-click="model.passes_cycle"
             rv-class-selected="ui.passes_inside"
             rv-inside="ui.passes_inside">--passes={model.passes}</p>
          <p rv-on-click="model.end_usage_cycle"
             rv-class-selected="ui.end_usage_inside"
             rv-inside="ui.end_usage_inside">--end-usage={model.end_usage}</p>
          <p id="target-bitrate"
             rv-class-selected="ui.target_bitrate_inside"
             rv-show="model.end_usage | in vbr cbr cq">--target-bitrate={model.target_bitrate}</p>
          <p rv-class-selected="ui.cq_level_inside"
             rv-show="model.end_usage | in cq q">--cq-level={model.cq_level}</p>
          <p rv-on-click="model.quality_cycle"
             rv-inside="ui.speed_inside"
             rv-class-selected="ui.speed_inside">--{model.quality} <span rv-show="model.quality | in rt good">--cpu-used={model.speed}</span>
          </p>
          <p rv-class-selected="ui.kf_min_dist_inside"
             rv-show="model.enable_kf_min_dist">--kf-min-dist={model.kf_min_dist}</p>
          <p rv-class-selected="ui.kf_max_dist_inside"
             rv-show="model.enable_kf_max_dist">--kf-max-dist={model.kf_max_dist}</p>
          <p rv-class-selected="ui.min_q_inside"
             rv-show="model.enable_min_q">--min-q={model.min_q}</p>
          <p rv-class-selected="ui.max_q_inside"
             rv-show="model.enable_max_q">--max-q={model.max_q}</p>
          <p rv-class-selected="ui.auto_alt_ref_inside"
             rv-show="model.auto_alt_ref">--auto-alt-ref=1</p>
          <p rv-class-selected="ui.auto_alt_ref_inside"
             rv-hide="model.auto_alt_ref">--auto-alt-ref=0</p>
          <p rv-class-selected="ui.tiles_inside"
             rv-show="model.tiles">--tile-rows={model.tile_rows} --tile-cols={model.tile_cols}</p>
          <p rv-class-selected="ui.aq_inside"
             rv-show="model.aq | in 1 2 3">--aq-mode={model.aq}</p>
          <p>input.y4m</p>
          <p rv-show="model.ivf">--ivf -o output.ivf</p>
          <p rv-hide="model.ivf">-o output.webm</p>
        </div>
      </div>

      <div class="section" rv-inside="ui.passes_inside">
        <div class="title">Passes</div>
        <div class="body">
          <label><input type="radio" name="passes" value="1" rv-checked="model.passes"/>Single</label><br/>
          <label><input type="radio" name="passes" value="2" rv-checked="model.passes"/>Multi</label><br/>
        </div>
      </div>

      <div class="section" rv-inside="ui.end_usage_inside">
        <div class="title">Usage</div>
        <div class="body">
          <label><input type="radio"
                        name="end-usage"
                        value="vbr"
                        rv-checked="model.end_usage"/>VBR (Variable Bitrate)
          </label><br/>

          <label><input type="radio"
                        name="end-usage"
                        value="cbr"
                        rv-checked="model.end_usage"/>CBR (Constant Bitrate)
          </label><br/>

          <label><input type="radio"
                        name="end-usage"
                        value="cq"
                        rv-checked="model.end_usage"/>CQ (Constained Quality)
          </label><br/>

          <label><input type="radio"
                        name="end-usage"
                        value="q"
                        rv-checked="model.end_usage"/>Q (Constant Quality)
          </label><br/>
        </div>
      </div>

      <div class="section" rv-inside="ui.speed_inside">
        <div class="title">Speed</div>
        <div class="body">
          <label><input type="radio" name="quality" value="rt" rv-checked="model.quality"/>Real Time</label>
          <label><input type="radio" name="quality" value="good" rv-checked="model.quality"/>Good</label>
          <label><input type="radio" name="quality" value="best" rv-checked="model.quality"/>Best</label><br/>
          <input type="range" min="0" max="10" rv-input="model.speed" rv-enabled="model.quality | in rt good"/>
          <span class="value" rv-text="model.speed"></span>
        </div>
      </div>

      <div class="section">
        <div class="title">Bitrate</div> 
        <div class="body" rv-inside="ui.target_bitrate_inside">
          <input type="text" rv-value="model.target_bitrate" rv-enabled="model.end_usage | in vbr cbr cq"/> kbps<br/>
        </div>
      </div>

      <div class="section">
        <div class="title">Quantization</div>
        <div class="body">
          <div rv-inside="ui.cq_level_inside">
            <label>Main Quantizer<input type="range" min="0" max="63" rv-input="model.cq_level" rv-enabled="model.end_usage | in cq q"/></label>
            <span class="value" rv-text="model.cq_level"></span>
          </div>

          <div rv-inside="ui.min_q_inside">
            <label><input type="checkbox" rv-checked="model.enable_min_q"/>Min Quantizer</label>
            <input type="range" min="0" max="63" rv-enabled="model.enable_min_q" rv-input="model.min_q"/>
            <span class="value" rv-text="model.min_q"></span>
          </div>

          <div rv-inside="ui.max_q_inside">
            <label><input type="checkbox" rv-checked="model.enable_max_q"/>Max Quantizer</label>
            <input type="range" min="0" max="63" rv-enabled="model.enable_max_q" rv-input="model.max_q"/>
            <span class="value" rv-text="model.max_q"></span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="title">Adaptive Quantization</div>
        <div class="body" rv-inside="ui.aq_inside">
          <label><input type="radio" name="aq" value="0" rv-checked="model.aq"/>Off</label><br/>
          <label><input type="radio" name="aq" value="1" rv-checked="model.aq"/>Variance</label><br/>
          <label><input type="radio" name="aq" value="2" rv-checked="model.aq"/>Complexity</label><br/>
          <label><input type="radio" name="aq" value="3" rv-checked="model.aq"/>Cyclic refresh</label>
        </div>
      </div>

      <div class="section">
        <div class="title">Tiles</div>
        <div class="body" rv-inside="ui.tiles_inside">
          <label><input type="checkbox" rv-checked="model.tiles"/>Enable</label>
            <select rv-value="model.tile_rows" rv-enabled="model.tiles">
              <option value="0">1</option>
              <option value="1">2</option>
              <option value="2">4</option>
            </select> &times;
            <select rv-value="model.tile_cols" rv-enabled="model.tiles">
              <option value="0">1</option>
              <option value="1">2</option>
              <option value="2">4</option>
              <option value="3">8</option>
              <option value="4">16</option>
              <option value="5">32</option>
              <option value="6">64</option>
            </select>
        </div> 
      </div>

      <div class="section">
        <div class="title">Key Frames</div>
        <div class="body">
          <div rv-inside="ui.kf_min_dist_inside">
            <label><input type="checkbox" rv-checked="model.enable_kf_min_dist"/>Min Distance</label>
            <input type="text" rv-enabled="model.enable_kf_min_dist" rv-input="model.kf_min_dist"/>frames
          </div>
          <div rv-inside="ui.kf_max_dist_inside">
            <label><input type="checkbox" rv-checked="model.enable_kf_max_dist"/>Max Distance</label>
            <input type="text" rv-enabled="model.enable_kf_max_dist" rv-input="model.kf_max_dist"/>frames
          </div>
        </div>
      </div>

      <div class="section">
        <div class="title">Alt Reference Frames</div>
        <div class="body" rv-inside="ui.auto_alt_ref_inside">
          <label><input type="checkbox" rv-checked="model.auto_alt_ref"/>Enable</label>
        </div>
      </div>

      <div class="section">
        <div class="title">Miscellaneous</div>
        <div class="body">
          <label rv-inside="ui.debug_inside">
            <input type="checkbox" rv-checked="model.debug"/>Debug mode
          </label><br/>
          <label rv-inside="ui.verbose_inside">
            <input type="checkbox" rv-checked="model.verbose"/>Show encoder paramters
          </label><br/>
          <label rv-inside="ui.psnr_inside">
            <input type="checkbox" rv-checked="model.psnr"/>Show PSNR in status line
          </label><br/>
          <label rv-inside="ui.quiet_inside">
            <input type="checkbox" rv-checked="model.quiet"/>Do not print encode progress
          </label><br/>
          <label>
            <input type="checkbox" rv-checked="model.ivf"/>Output IVF file
          </label><br/>
        </div>
      </div>
    </div>
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="js/ZeroClipboard.min.js"></script>
    <script type="text/javascript" src="js/rivets.min.js"></script>
    
    <script>
      var ui = {
        passes_inside: false,
        end_usage_inside: false,
        target_bitrate_inside: false,
        cq_level_inside: false,
        speed_inside: false,
        aq_inside: false,
        tiles_inside: false,
        debug_inside: false,
        verbose_inside: false,
        psnr_inside: false,
        quiet_inside: false,
        min_q_inside: false,
        max_q_inside: false,
        kf_min_dist_inside: false,
        kf_max_dist_inside: false,
        auto_alt_ref_inside: false,
      };

      function getParamCycle(param, values) {
        return function(event, models) {
          var model = models.model;
          model[param] = values[($.inArray(model[param], values) + 1) % values.length];
        };
      }

      var m = {codec:'vp9', 
               debug: false,
               verbose: false,
               psnr: false,
               quet: false,
               ivf: false,
               passes: 2,            // 1, 2
               passes_cycle: getParamCycle('passes', [1, 2]),
               end_usage: 'vbr',     // 'vbr', 'cbr', 'cq', 'q'
               end_usage_cycle: getParamCycle('end_usage', ['vbr', 'cbr', 'cq', 'q']),
               quality: 'good',      // 'rt', 'good', 'best'
               quality_cycle: getParamCycle('quality', ['rt', 'good', 'best']),
               speed: 1,             // 1, 2, 3, ..., 10
               target_bitrate: 600,  // > 0
               cq_level: 10,         // 0, 1, 2, ..., 63
               aq: 0,                // 0, 1, 2, 3
               tiles: false,
               tile_rows: 0,
               tile_cols: 0,
               auto_alt_ref: 1,
               enable_kf_min_dist: false,
               enable_kf_max_dist: false,
               kf_min_dist: 0,
               kf_max_dist: 9999,
               enable_min_q: false,
               enable_max_q: false,
               min_q: 0,
               max_q: 63
             };

      rivets.binders.inside = {
        publishes: true,
        bind: function(el) {
          var self = this;

          this.enter_callback = function() {
            self.observer.publish(1);
          }

          this.leave_callback = function() {
            self.observer.publish(0);
          }

          $(el).on('mouseenter', this.enter_callback);
          $(el).on('mouseleave', this.leave_callback);
        },

        unbind: function(el) {
          $(el).off('mouseenter', this.enter_callback)
          $(el).off('mouseleave', this.leave_callback);
        },
      };

      rivets.binders.input = {
        publishes: true,
        routine: rivets.binders.value.routine,
        bind: function (el) {
          $(el).on('input change', this.publish);
        },
        unbind: function (el) {
          $(el).off('input change', this.publish);
        }
      };

      rivets.formatters.eq = function (value, args) {
        return value === args;
      };

      rivets.formatters.in = function (value, args) {
        return $.inArray(value, arguments, 1) !== -1;
      };

      var view = rivets.bind($('#panel'), {
        model: m,
        ui: ui
      });

      var rangeControl = null

      /*$.each(view.bindings, function(index, binding){
        var el = binding.el;
        if (el.nodeName === "INPUT" && el.type === "range") {
          $(el)
            .on('mouseenter', function(event) {
              rangeControl = $(event.target);
            })
            .on('mouseleave', function(event ) {
              rangeControl = null;
            });
        }
      });*/



      $('#cmd').css('visibility', 'visible');

      var rangeControl = null;
      $('#panel input[type=range]')
        .on('mouseenter', function(event){
          rangeControl = $(event.target);
        })
        .on('mouseleave', function(event ){
          rangeControl = null;
        });

      var control = null;

      /*$('#target-bitrate')
        .on('mouseenter', function(event) {
          console.log(event.target);
          control = event.target; 
        })
        .on('mouseleave', function (event) {
          control = null;
        });*/

      $(document).on('keydown', function(event) {
        if (rangeControl) {
          var val = parseInt(rangeControl.val());
          if (event.keyCode === 38) {
            rangeControl.val(val + 1).trigger('change');
            event.preventDefault();
          } else if (event.keyCode === 40) {
            rangeControl.val(val - 1).trigger('change');
            event.preventDefault();
          }
        }

        if (control) {
          var delta = (event.ctrlKey && event.shiftKey) ? 1000 : (event.shiftKey ? 100 : 10);

          if (event.keyCode === 38) {
            m.target_bitrate += delta;
            event.preventDefault();
          } else if (event.keyCode === 40) {
            m.target_bitrate -= delta;
            event.preventDefault();
          }
        }
      });


      $(document).on('mousewheel', function(event) {
        if (rangeControl) {
          var delta = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var val = parseInt(rangeControl.val());
          rangeControl.val(val + delta).trigger('change');
          event.preventDefault();
        }

        if (control) {
          var mult = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var delta = (event.ctrlKey && event.shiftKey) ? 1000 : (event.shiftKey ? 100 : 10);
          m.target_bitrate += mult * delta;
          event.preventDefault();
        }
      });

      var client = new ZeroClipboard($('#cmd-copy'));
      client.on('copy', function(event) {
        //var cmd = $('#cmd').children(":visible").text(); //.replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        var cmd = $('#cmd-line').children(":visible").map(function(){ return $(this).text() }).get().join(' ').replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        console.log(cmd);
        var clipboard = event.clipboardData;
        clipboard.setData("text/plain", cmd);
      });

      

    </script>
  </body>
</html>
