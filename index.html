<html>
  <head>
    <title>libvpx cli generator</title>
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        border: 0;
      }

      input[type='radio'] {
        cursor: pointer; 
      }
      label { 
        cursor: pointer; 
      }

      .section {
        margin-bottom: 5px;
        margin-left: 10px;
      }

      .section .title {
        font-weight: bold;
      }

      .section .body {
        margin-left: 5px;
      }

      .selected {
        padding-bottom: 1px;
        border-bottom: 1px dashed;
      }

      .indent {
        margin-left: 10px;
      }

      #cmd {
        font-size:12pt;
        font-family:monospace;
        color:white;
      }

    </style>
  </head>
  <body>
    

    <div id="panel">
      <div style="background-color:black;padding-top:10px;padding-bottom:10px;padding-left:5px">
        <button id="cmd-copy">Copy</button>
        <span id="cmd" style="visibility:hidden">
          <span>vpxenc --codec=vp9</span>
          <span rv-class-selected="ui.debug_inside" rv-show="model.debug">--debug</span>
          <span rv-class-selected="ui.verbose_inside" rv-show="model.verbose">--verbose</span>
          <span rv-class-selected="ui.psnr_inside" rv-show="model.psnr">--psnr</span>
          <span rv-class-selected="ui.quiet_inside" rv-show="model.quiet">--quiet</span>
          <span rv-class-selected="ui.passes_inside">--passes={model.passes}</span>
          <span rv-class-selected="ui.end_usage_inside">--end-usage={model.end_usage}</span>
          <span id="target-bitrate" rv-class-selected="ui.target_bitrate_inside" rv-show="model.end_usage | in vbr cbr cq">--target-bitrate={model.target_bitrate}</span>
          <span rv-class-selected="ui.cq_level_inside" rv-show="model.end_usage | in cq q">--cq-level={model.cq_level}</span>
          <span rv-class-selected="ui.speed_inside">--{model.quality} <span rv-show="model.quality | in rt good">--cpu-used={model.speed}</span></span>
          <span rv-class-selected="ui.min_max_q_inside" rv-show="model.min_max_q">--min-q={model.min_q} --max-q={model.max_q}</span>
          <span rv-class-selected="ui.auto_alt_ref_inside" rv-show="model.auto_alt_ref">--auto-alt-ref=1</span>
          <span rv-class-selected="ui.auto_alt_ref_inside" rv-hide="model.auto_alt_ref">--auto-alt-ref=0</span>
          <span rv-class-selected="ui.tiles_inside" rv-show="model.tiles">--tile-rows={model.tile_rows} --tile-cols={model.tile_cols}</span>
          <span rv-class-selected="ui.aq_inside" rv-show="model.aq | in 1 2 3">--aq-mode={model.aq}</span>
          <span>input.y4m</span>
          <span rv-show="model.ivf">--ivf -o output.ivf</span>
          <span rv-hide="model.ivf">-o output.webm</span>
        </span>
      </div>

      <div class="section" rv-inside="ui.passes_inside">
        <div class="title">Passes</div>
        <div class="body">
          <label><input type="radio" name="passes" value="1" rv-checked="model.passes">One</input></label><br/>
          <label><input type="radio" name="passes" value="2" rv-checked="model.passes">Two</input></label><br/>
        </div>
      </div>

      <div class="section" rv-inside="ui.end_usage_inside">
        <div class="title">Usage</div>
        <div class="body">
          <label><input type="radio" 
                        name="end-usage" 
                        value="vbr" 
                        rv-checked="model.end_usage">VBR (Variable Bitrate)</input>
          </label><br/>

          <label><input type="radio" 
                        name="end-usage" 
                        value="cbr" 
                        rv-checked="model.end_usage">CBR (Constant Bitrate)</input>
          </label><br/>

          <label><input type="radio" 
                        name="end-usage" 
                        value="cq"  
                        rv-checked="model.end_usage">CQ (Constained Quality)</input>
          </label><br/>

          <label><input type="radio" 
                        name="end-usage" 
                        value="q"   
                        rv-checked="model.end_usage">Q (Constant Quality)</input>
          </label><br/>
        </div>
      </div>

      <div class="section" rv-inside="ui.speed_inside">
        <div class="title">Speed</div>
        <div class="body">
          <label><input type="radio" name="quality" value="rt" rv-checked="model.quality">Real Time</input></label>
          <label><input type="radio" name="quality" value="good" rv-checked="model.quality">Good</input></label>
          <label><input type="radio" name="quality" value="best" rv-checked="model.quality">Best</input></label><br/>
          <input type="range" min="0" max="10" rv-input="model.speed" rv-enabled="model.quality | in rt good"><span rv-text="model.speed"></span>
        </div>
      </div>

      <div class="section" rv-show="model.end_usage | in vbr cbr cq" rv-inside="ui.target_bitrate_inside">
        <div class="title">Target Bitrate</div> 
        <div class="body">
          <input type="text" rv-value="model.target_bitrate"/> kbps<br/>
        </div>
      </div>

      <div class="section" rv-show="model.end_usage | in cq q" rv-inside="ui.cq_level_inside">
        <div class="title">Quantization Level</div>
        <div class="body">
          <input type="range" min="0" max="63" rv-input="model.cq_level"/>
          <span rv-text="model.cq_level"></span><br/>
        </div>
      </div>

      <div class="section" rv-inside="ui.aq_inside">
        <div class="title">Adaptive Quantization</div>
        <div class="body">
          <label><input type="radio" name="aq" value="0" rv-checked="model.aq">Off</input></label><br/>
          <label><input type="radio" name="aq" value="1" rv-checked="model.aq">Variance</input></label><br/>
          <label><input type="radio" name="aq" value="2" rv-checked="model.aq">Complexity</input></label><br/>
          <label><input type="radio" name="aq" value="3" rv-checked="model.aq">Cyclic refresh</input></label>
        </div>
      </div>

      <div class="section" rv-inside="ui.tiles_inside">
        <div class="title">Tiles</div>
        <div class="body">
          <label><input type="checkbox" rv-checked="model.tiles">Enable</label>
            <select rv-value="model.tile_rows" rv-enabled="model.tiles">
              <option value="0">1</option>
              <option value="1">2</option>
              <option value="2">4</option>
            </select> &times;
            <select rv-value="model.tile_cols" rv-enabled="model.tiles">
              <option value="0">1</option>
              <option value="1">2</option>
              <option value="2">4</option>
              <option value="3">8</option>
              <option value="4">16</option>
              <option value="5">32</option>
              <option value="6">64</option>
            </select>
        </div> 
      </div>

      <div class="section" rv-inside="ui.min_max_q_inside">
        <div class="title">Min/Max Quantization Levels</div>
        <div class="body">
          <label><input type="checkbox" rv-checked="model.min_max_q">Enable</label><br/ >
          <div class="indent">
            <label>Min quantizer <input type="range" min="0" max="63" rv-enabled="model.min_max_q" rv-input="model.min_q"></label>
            <span></span><br/>
            <label>Max quantizer <input type="range" min="0" max="63" rv-enabled="model.min_max_q" rv-input="model.max_q"></label>
          </div>
        </div>
      </div>

      <div class="section" rv-inside="ui.auto_alt_ref_inside">
        <div class="title">Alt Reference Frames</div>
        <div class="body">
          <label><input type="checkbox" rv-checked="model.auto_alt_ref">Enable</label>
        </div>
      </div>

      <div class="section">
        <div class="title">Miscellaneous</div>
        <div class="body">
          <label rv-inside="ui.debug_inside">
            <input type="checkbox" rv-checked="model.debug">Debug mode
          </label><br/>
          <label rv-inside="ui.verbose_inside">
            <input type="checkbox" rv-checked="model.verbose">Show encoder paramters
          </label><br/>
          <label rv-inside="ui.psnr_inside">
            <input type="checkbox" rv-checked="model.psnr">Show PSNR in status line
          </label><br/>
          <label rv-inside="ui.quiet_inside">
            <input type="checkbox" rv-checked="model.quiet">Do not print encode progress
          </label><br/>
          <label>
            <input type="checkbox" rv-checked="model.ivf">Output IVF file
          </label><br/>
        </div>
      </div>
    </div>
    
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="js/ZeroClipboard.min.js"></script>
    <script type="text/javascript" src="js/rivets.min.js"></script>
    
    <script>
      var ui = {
        passes_inside: false,
        end_usage_inside: false,
        target_bitrate_inside: false,
        cq_level_inside: false,
        speed_inside: false,
        aq_inside: false,
        tiles_inside: false,
        debug_inside: false,
        verbose_inside: false,
        psnr_inside: false,
        quiet_inside: false,
        min_max_q_inside: false,
        auto_alt_ref_inside: false,
      };

      var m = {codec:'vp9', 
               debug: false,
               verbose: false,
               psnr: false,
               quet: false,
               ivf: false,
               passes: 2, 
               end_usage: 'vbr', 
               quality: 'good', 
               speed: 1, 
               target_bitrate: 600, 
               cq_level: 10,
               aq: 0,
               tiles: false,
               tile_rows: 0,
               tile_cols: 0,
               auto_alt_ref: 1,
               min_max_q: false,
               min_q: 0,
               max_q: 63
             };

      rivets.binders.inside = {
        publishes: true,
        bind: function(el) {
          var self = this;

          this.enter_callback = function() {
            self.observer.publish(1);
          }

          this.leave_callback = function() {
            self.observer.publish(0);
          }

          $(el).on('mouseenter', this.enter_callback);
          $(el).on('mouseleave', this.leave_callback);
        },

        unbind: function(el) {
          $(el).off('mouseenter', this.enter_callback)
          $(el).off('mouseleave', this.leave_callback);
        },
      };

      rivets.binders.input = {
          publishes: true,
          routine: rivets.binders.value.routine,
          bind: function (el) {
            el.addEventListener('input', this.publish);
          },
          unbind: function (el) {
            el.removeEventListener('input', this.publish);
          }
      };

      rivets.formatters.eq = function (value, args) {
        return value === args;
      };

      rivets.formatters.in = function (value, args) {
        return $.inArray(value, arguments, 1) !== -1;
      };

      rivets.bind($('#panel'), {
        model: m,
        ui: ui
      });

      $('#cmd').css('visibility', 'visible');

      var control = null;

      $('#target-bitrate')
        .on('mouseenter', function(event) {
          console.log(event.target);
          control = event.target; 
        })
        .on('mouseleave', function (event) {
          control = null;
        });

      $(document).on('keydown', function(event) {
        if (control) {
          var delta = (event.ctrlKey && event.shiftKey) ? 1000 : (event.shiftKey ? 100 : 10);

          if (event.keyCode === 38) {
            m.target_bitrate += delta;
            event.preventDefault();
          } else if (event.keyCode === 40) {
            m.target_bitrate -= delta;
            event.preventDefault();
          }
        }
      });


      $(document).on('mousewheel', function(event) {
        if (control) {
          var mult = event.originalEvent.wheelDelta > 0 ? 1 : -1;
          var delta = (event.ctrlKey && event.shiftKey) ? 1000 : (event.shiftKey ? 100 : 10);
          m.target_bitrate += mult * delta;
          event.preventDefault();
        }
      });

      var client = new ZeroClipboard($('#cmd-copy'));
      client.on('copy', function(event) {
        //var cmd = $('#cmd').children(":visible").text(); //.replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        var cmd = $('#cmd').children(":visible").map(function(){ return $(this).text() }).get().join(' ').replace(/(\r\n|\n|\r)/gm," ").replace(/\s+/g," ").trim();
        console.log(cmd);
        var clipboard = event.clipboardData;
        clipboard.setData("text/plain", cmd);
      });

      

    </script>
  </body>
</html>
